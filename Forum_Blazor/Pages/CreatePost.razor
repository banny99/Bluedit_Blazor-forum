@page "/CreatePost"
@using Microsoft.AspNetCore.Components
@using Entities.Models
@using Entities.Interfaces
@using Forum_Blazor.Authentication
@using UIElements

@inject IPostDAO PostDao
@inject IAuthService authService
@inject NavigationManager NavMgr


<div class="box">
    <h3>CreatePost</h3>
    
    <EditForm Model="@newPost" OnValidSubmit="@CreateNewPost">
            <DataAnnotationsValidator/>
            <ValidationSummary/>
           
            <div class="form-group field">
                <span>
                    <label>Header:</label>
                </span>
                <span>
                    <InputText @bind-Value="newPost.Header"/>
                </span>
            </div>
            <div class="form-group field">
                <span>
                    <label>Body:</label>
                </span>
                <span>
                    <InputTextArea rows="4" @bind-Value="newPost.Body"/>
                </span>
            </div>
            <p class="actions">
                <button class="acceptbtn" type="submit">Create</button>
            </p>
        </EditForm>
    
    
    @if(!string.IsNullOrEmpty(errorLabel))
    {
        <label>@errorLabel</label>
    }
    
    @if (showModal)
    {
        <Modal>
            <p>Do you really wish to add a new Post?</p>
            <button @onclick="@Submit">Create</button>
            <button @onclick="@Edit">Edit</button>
            <button @onclick="@Cancel">Cancel</button>
        </Modal>
    }
    
    
</div>

@code {
    
    private Post newPost = new Post();
    private string errorLabel = String.Empty;
    
    private bool showModal;
    
    private async Task CreateNewPost()
    {
        errorLabel = "";
        try
        {
            showModal = true;
        }
        catch (Exception e)
        {
            errorLabel = e.Message;
        }
    }
    

    private async void Submit()
    {
        newPost.Author = authService.GetLoggedUser();
        await PostDao.AddAsync(newPost);
        newPost = new Post();
        showModal = false;
        NavMgr.NavigateTo("/Posts");
    }

    private void Edit()
    {
        showModal = false;
    }

    private void Cancel()
    {
        newPost = new Post();
        showModal = false;
        NavMgr.NavigateTo("/Posts");
    }

}