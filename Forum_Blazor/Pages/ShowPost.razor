@page "/ShowPost/{Id:int}"
@using Entities.Models
@using Contracts.Services
@using Forum_Blazor.Authentication

@inject IPostService _postService
@inject IUserService _userService
@inject NavigationManager _navMgr
@inject IAuthService _authService


<PageTitle>Post : @_shownPost</PageTitle>

<div class="box">
    <h3>@_shownPost.Header</h3>
    <h5>Author: @_shownPost.Author.UserName</h5>
    <p>
        @_shownPost.Body
    </p>
    
    <div class="form-outline">
        <input type="text" id="form16" class="form-control" data-mdb-showcounter="true" maxlength="20" @bind="_comment.Text"/>
        <label class="form-label" for="form16">Comment ...</label>
        <button type="button" class="btn btn-primary btn-rounded" @onclick="Comment">submit</button>
    </div>
    
    
    
    @if (!string.IsNullOrEmpty(_errorLabel))
    {
        <label>@_errorLabel</label>
    }

    @if (!_shownPost.Comments.Any())
    {
        <br/>
        <div class="card">
            <div class="card-header">Comments</div>
            <div class="card-body">
                 <em>No coments exist...</em>
            </div>
        </div>
    }

    else
    {
        <br/>
        <div class="card">
            <div class="card-header">Comments</div>
            <div class="card-body">
                @foreach (var comment in _shownPost.Comments)
                        {
                            <br/>
                            <div class="card">
                                <div class="card-header">@comment.WrittenBy.UserName</div>
                                <div class="card-body">
                                    <blockquote class="blockquote mb-0">
                                        <p>@comment.Text</p>
                                        <footer class="blockquote-footer">(timestamp)?</footer>
                                    </blockquote>
                                </div>
                            </div>
                        }
            </div>
        </div>
    }

</div>


@code {
    [Parameter]
    public int Id { get; set; }

    private Post _shownPost = null!;
    private string _errorLabel = String.Empty;

    private Comment _comment = new Comment();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _shownPost = await _postService.GetById(Id);
        }
        catch (Exception e)
        {
            _errorLabel = e.Message;
        }
        
    }

    private void Comment()
    {
        if ( string.IsNullOrEmpty(_comment.Text))
        {
            Console.WriteLine("invalid comment");
            _errorLabel = "invalid comment";
        }
        else
        {
            _comment.WrittenBy = _authService.GetLoggedUser();
            
            //if writtenBy == null:
            _comment.WrittenBy ??= new User("anonym");
            _postService.AddComment(_shownPost, _comment);
        }
        
        _comment = new Comment();
    }

}